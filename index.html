<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSIF Castione - GESTIONE OPERATIVA V4.0</title>
    <style>
        :root { --securitas-blue: #003366; --securitas-red: #e30613; --bg: #f4f7f9; --success: #28a745; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .banner-container { width: 100%; background: white; text-align: center; border-bottom: 1px solid #ddd; }
        .banner-top { width: 100%; max-width: 800px; height: auto; display: block; margin: 0 auto; }
        .header { width: 100%; background: white; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 5px solid var(--securitas-red); }
        .logo-securitas { height: 32px; }
        .container { width: 95%; max-width: 850px; margin: 20px auto; padding-bottom: 60px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); display: none; text-align: center; }
        .active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        h2 { color: var(--securitas-blue); font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; }
        button { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 8px; background-color: var(--securitas-blue); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-red { background: var(--securitas-red); }
        .btn-gray { background: #6c757d; }
        .btn-outline { background: transparent; border: 2px solid var(--securitas-blue); color: var(--securitas-blue); }

        /* Checklist UI */
        .counter-badge { background: var(--securitas-red); color: white; padding: 10px 20px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; display: inline-block; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(227,6,19,0.3); }
        .checklist-row { display: flex; align-items: flex-start; padding: 15px; border-bottom: 1px solid #eee; background: #fff; gap: 15px; text-align: left; }
        .check-col input { width: 28px; height: 28px; cursor: pointer; }
        .task-text { font-size: 1rem; font-weight: 600; color: #333; display: block; }
        .task-note { font-size: 0.85rem; color: #444; background: #fdf2f2; border-left: 4px solid var(--securitas-red); padding: 10px; margin-top: 5px; display: block; line-height: 1.4; white-space: pre-wrap; }
        .time-col { font-size: 0.85rem; color: var(--success); font-weight: bold; min-width: 65px; text-align: right; }

        /* Admin Management */
        .admin-section { margin-top: 25px; border-top: 2px solid #eee; padding-top: 15px; text-align: left; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

    <div class="banner-container"><img src="logo_nsif.jpg" alt="Banner" class="banner-top" onerror="this.style.display='none'"></div>
    <div class="header">
        <img src="https://www.securitas.ch/_assets/1f4f58cb8ec7ef7ef807190874a5a8cd/img/logos/securitas.svg" alt="Securitas" class="logo-securitas">
        <div style="font-weight: bold; color: var(--securitas-blue); font-size: 0.9rem; margin-top:5px;">NSIF CASTIONE - SISTEMA INTEGRALE V4.0</div>
    </div>

    <div class="container">
        <div id="step_login" class="card active">
            <h2>Accesso Riservato</h2>
            <input type="text" id="login_user" placeholder="Email Securitas">
            <input type="password" id="login_pass" placeholder="Password">
            <button onclick="Auth.login()">ACCEDI</button>
        </div>

        <div id="step_menu" class="card">
            <h2>Menu Principale</h2>
            <button onclick="UI.showStep('step_azienda_tipo')">üõÇ GESTIONE ACCESSI</button>
            <button class="btn-red" onclick="UI.showStep('step_checklist_menu')">üìã CHECKLIST TURNI</button>
            <button class="btn-outline" onclick="UI.openVTI()">üìÇ VTI EXTERNAL (SHAREPOINT)</button>
            <div id="admin_area" style="display:none; border-top: 2px dashed #ccc; margin-top:20px; padding-top:10px;">
                <button class="btn-red" onclick="Admin.openPanel()">‚öôÔ∏è AMMINISTRAZIONE</button>
            </div>
            <button class="btn-gray" onclick="location.reload()" style="margin-top:20px;">LOGOUT</button>
        </div>

        <div id="step_checklist_menu" class="card">
            <h2>Seleziona Turno</h2>
            <button onclick="Checklist.open('T1')">TURNO T1</button>
            <button onclick="Checklist.open('T2')">TURNO T2</button>
            <button onclick="Checklist.open('T3')">TURNO T3</button>
            <button class="btn-gray" onclick="UI.showStep('step_menu')">INDIETRO</button>
        </div>

        <div id="step_checklist_view" class="card" style="max-width: 800px;">
            <div id="task_counter" class="counter-badge">Attivit√† mancanti: 0</div>
            <h2 id="checklist_title"></h2>
            <div id="checklist_items_container"></div>
            <button class="btn-red" style="margin-top:30px;" onclick="UI.showStep('step_menu')">CHIUDI E SALVA</button>
        </div>

        <div id="step_azienda_tipo" class="card">
            <h2>Gestione Accessi</h2>
            <button onclick="alert('Flusso OFT caricato')">Azienda OFT</button>
            <button onclick="alert('Flusso FFS caricato')">Azienda FFS</button>
            <button class="btn-gray" onclick="UI.showStep('step_menu')">INDIETRO</button>
        </div>

        <div id="step_admin" class="card">
            <h2>Pannello di Controllo</h2>
            
            <div class="admin-section">
                <h3>Aggiungi Operazione a Checklist</h3>
                <select id="add_task_turno">
                    <option value="T1">Turno T1</option>
                    <option value="T2">Turno T2</option>
                    <option value="T3">Turno T3</option>
                </select>
                <input type="text" id="add_task_title" placeholder="Titolo Operazione">
                <textarea id="add_task_note" placeholder="Osservazioni/Note operative" rows="2"></textarea>
                <button onclick="Admin.addTask()">AGGIUNGI OPERAZIONE</button>
            </div>

            <div class="admin-section">
                <h3>Modifica Operazioni Esistenti</h3>
                <div style="overflow-x:auto;">
                    <table class="admin-table">
                        <thead><tr><th>Turno</th><th>Descrizione</th><th>Azioni</th></tr></thead>
                        <tbody id="admin_tasks_body"></tbody>
                    </table>
                </div>
            </div>

            <button class="btn-gray" onclick="UI.showStep('step_menu')" style="margin-top:20px;">ESCI</button>
        </div>
    </div>

    <script>
        const MASTER = { email: "marco.lamorgia@securitas.ch", pass: "1234NSIF" };

        // Dati iniziali fedeli ai documenti allegati
        const defaultData = {
            T1: [
                { t: "Inizio turno: 06:00 ‚Äì 15:00 o 14:45 ‚Äì 22:00", n: "Verificare l'orario di inizio corretto." },
                { t: "Apertura cancello Campo Base Nord", n: "Tramite lucchetto. Codice 6988" },
                { t: "Parcheggio auto Securitas", n: "Di fronte ufficio 'Coordinamento Securitas', posto tutto a destra." },
                { t: "Apertura ufficio Campo Base Nord", n: "Codice 1907. Alzare tapparelle e verificare riscaldamento (Inverno pos. 4)." },
                { t: "Telefono di servizio", n: "Pin 6681, Sblocco 1907. Tenerlo fino all'arrivo del T3." },
                { t: "Radio personale", n: "Accendere ed effettuare prova collegamento su Canale 15." },
                { t: "Apertura CAST07", n: "Codice 1907. Verificare riscaldamento (21¬∞ inverno) e tornelli/luci." },
                { t: "Verifica monopattino CAST07", n: "Verde = Carico, Rosso = In carica." },
                { t: "Sblocco PC", n: "Password in mappetta gialla nell'armadio." },
                { t: "VTI External - Scharing documenti", n: "Aprire archivio documentazione aggiornata." },
                { t: "Presidio CAST08 (Se richiesto)", n: "Registrare: Nome, Azienda, Targa, Ore. Solo per mezzi pesanti. Massimo 2 ore." },
                { t: "Pulizia fine turno CAST07", n: "Passare straccio a terra e svuotare cestini." }
            ],
            T2: [
                { t: "Apertura cancelli CAST09", n: "Entrata e Uscita tramite lucchetto. Codice 6988." },
                { t: "Apertura ufficio CAST09", n: "Codice 1907. Alzare tapparelle e serrande tornello." },
                { t: "Verifica barriera e fotocellule", n: "Se bloccata in inverno, pulire fotocellule." },
                { t: "Campo Base Sud (Inverno)", n: "Aprire porta e chiudere rubinetti bagni. Chiave in Keybox interno." },
                { t: "Presidio CAST09", n: "Registrare mezzi: Nome, Azienda, DPI, Ore. DPI mancanti fornibili come pegno." },
                { t: "Badge provvisori", n: "Se operai sprovvisti, contattare Nijaz/Loris/Angelo se NON in Bausicht." },
                { t: "Pulizia CAST09", n: "Passare straccio a terra obbligatoriamente entro le 22:00." }
            ],
            T3: [
                { t: "Parcheggio auto", n: "Fronte ufficio 'Coordinamento Securitas', al centro." },
                { t: "Giro perimetro interno", n: "Controllare punti sbarrati o cambiamenti. Ritirare telefono dal CAST07." },
                { t: "Controllo CAST08", n: "Verificare che non sia aperto senza presidio. Se vuoto, chiudere." },
                { t: "Controllo Pausa (12:00-13:00)", n: "Nessun operaio deve mangiare in cantiere. Indirizzare in mensa." },
                { t: "Chiusura Campo Base Sud (Inverno)", n: "Aprire leggermente rubinetti per evitare gelo, spegnere luci." },
                { t: "Chiusura uffici CSC", n: "Codice 6990. Verificare finestre e luci (solo parte visibile)." },
                { t: "Fine turno: Ricarica", n: "Mettere in carica telefono di servizio e monopattini (CAST07 e 09)." }
            ]
        };

        // Inizializzazione dati da localStorage
        let checklistData = JSON.parse(localStorage.getItem('nsif_checklist_v4')) || defaultData;

        const UI = {
            showStep: (id) => {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },
            openVTI: () => window.open("https://ssgwp.sharepoint.com/teams/TONCH_Collab_2_16/Freigegebene%20Dokumente/Forms/AllItems.aspx?id=%2Fteams%2FTONCH%5FCollab%5F2%5F16%2FFreigegebene%20Dokumente%2FTON%20%26%20TAS%2FFFS%5FCantiere%20nuove%20officine%20Castione%2FNSIF%20Castione%20%2D%20Team", '_blank')
        };

        const Checklist = {
            open: function(turno) {
                document.getElementById('checklist_title').innerText = "DISPOSIZIONI " + turno;
                const container = document.getElementById('checklist_items_container');
                container.innerHTML = checklistData[turno].map((item, i) => `
                    <div class="checklist-row">
                        <div class="check-col"><input type="checkbox" onchange="Checklist.update()"></div>
                        <div class="text-col">
                            <span class="task-text">${item.t}</span>
                            <span class="task-note">${item.n}</span>
                        </div>
                        <div class="time-col"></div>
                    </div>
                `).join('');
                UI.showStep('step_checklist_view');
                this.update();
            },
            update: function() {
                const rows = document.querySelectorAll('.checklist-row');
                let rem = 0;
                rows.forEach(r => {
                    const cb = r.querySelector('input');
                    const time = r.querySelector('.time-col');
                    if(!cb.checked) rem++;
                    if(cb.checked && time.innerText === "") time.innerText = new Date().toLocaleTimeString('it-CH',{hour:'2-digit',minute:'2-digit'});
                    if(!cb.checked) time.innerText = "";
                });
                document.getElementById('task_counter').innerText = "Attivit√† mancanti: " + rem;
            }
        };

        const Admin = {
            openPanel: function() { this.renderTasks(); UI.showStep('step_admin'); },
            addTask: function() {
                const turno = document.getElementById('add_task_turno').value;
                const title = document.getElementById('add_task_title').value;
                const note = document.getElementById('add_task_note').value;
                if(!title) return alert("Inserisci un titolo");
                checklistData[turno].push({t: title, n: note});
                this.save();
                this.renderTasks();
                alert("Operazione aggiunta!");
            },
            deleteTask: function(turno, index) {
                if(confirm("Eliminare questa operazione?")) {
                    checklistData[turno].splice(index, 1);
                    this.save();
                    this.renderTasks();
                }
            },
            renderTasks: function() {
                let html = "";
                ["T1", "T2", "T3"].forEach(turno => {
                    checklistData[turno].forEach((item, i) => {
                        html += `<tr>
                            <td>${turno}</td>
                            <td><b>${item.t}</b></td>
                            <td><button class="btn-red" style="padding:5px; font-size:0.7rem;" onclick="Admin.deleteTask('${turno}', ${i})">CANCELLA</button></td>
                        </tr>`;
                    });
                });
                document.getElementById('admin_tasks_body').innerHTML = html;
            },
            save: () => localStorage.setItem('nsif_checklist_v4', JSON.stringify(checklistData))
        };

        const Auth = {
            login: () => {
                const u = document.getElementById('login_user').value;
                const p = document.getElementById('login_pass').value;
                if (u === MASTER.email && p === MASTER.pass) {
                    document.getElementById('admin_area').style.display = 'block';
                    UI.showStep('step_menu');
                } else alert("Credenziali errate");
            }
        };
    </script>
</body>
</html>
