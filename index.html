<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSIF Castione Hub - V5.0 MODULAR SYSTEM</title>
    <style>
        :root { --securitas-blue: #003366; --securitas-red: #e30613; --bg: #f4f7f9; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        /* Layout */
        .header { background: var(--white); padding: 15px; text-align: center; border-bottom: 4px solid var(--securitas-red); }
        .logo { height: 35px; }
        .container { width: 95%; max-width: 1000px; margin: 20px auto; padding-bottom: 50px; }
        
        /* Moduli (Card) */
        .module { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; }
        .active { display: block; animation: fadeIn 0.4s; }
        
        /* UI Elements */
        .btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-primary { background: var(--securitas-blue); color: white; }
        .btn-danger { background: var(--securitas-red); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--securitas-blue); color: var(--securitas-blue); }
        .btn-secondary { background: #6c757d; color: white; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-card { background: white; padding: 30px; border-radius: 12px; border: 1px solid #eee; text-align: center; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .menu-card:hover { border-color: var(--securitas-red); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f8f9fa; }

        /* Flow & Checklist */
        .flow-box { text-align: left; background: #fff5f5; border-left: 5px solid var(--securitas-red); padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
        .check-row { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .timestamp { margin-left: auto; font-size: 0.8rem; color: var(--securitas-blue); font-weight: bold; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body onload="App.init()">

    <div class="header">
        <img src="https://www.securitas.ch/_assets/1f4f58cb8ec7ef7ef807190874a5a8cd/img/logos/securitas.svg" class="logo">
        <div style="font-size: 0.8rem; font-weight: bold; color: var(--securitas-blue);">SISTEMA MODULARE NSIF - V5.0</div>
    </div>

    <div class="container">

        <div id="mod-login" class="module active">
            <h2 style="text-align: center;">ACCESSO SISTEMA</h2>
            <input type="text" id="login-email" placeholder="Email Utente">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn btn-primary" onclick="Auth.login()">ACCEDI</button>
        </div>

        <div id="mod-admin" class="module">
            <h2>‚öôÔ∏è GESTIONE UTENTI & PRIVILEGI</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h4>Aggiungi / Modifica Utente</h4>
                <input type="text" id="adm-email" placeholder="Email">
                <input type="text" id="adm-pass" placeholder="Password (lascia vuoto per non cambiare)">
                <select id="adm-role">
                    <option value="user">User (Solo Checklist)</option>
                    <option value="admin">Admin (Gestione Completa)</option>
                </select>
                <button class="btn btn-primary" onclick="Admin.saveUser()">SALVA / AGGIORNA UTENTE</button>
            </div>
            <table id="user-table">
                <thead><tr><th>Email</th><th>Ruolo</th><th>Azioni</th></tr></thead>
                <tbody id="user-list"></tbody>
            </table>
            <button class="btn btn-secondary" onclick="Router.go('mod-menu')">TORNA AL MENU</button>
        </div>

        <div id="mod-menu" class="module">
            <div id="display-date" style="text-align: center; font-size: 1.5rem; font-weight: 800; color: var(--securitas-blue); margin-bottom: 20px;"></div>
            <div class="grid-menu">
                <div class="menu-card" onclick="Router.go('mod-accessi')">üõÇ CONTROLLO ACCESSI</div>
                <div class="menu-card" style="background: var(--securitas-red); color: white;" onclick="Router.go('mod-checklist-menu')">üìã CHECK-LIST TURNI</div>
                <div class="menu-card" onclick="window.open('https://app.bausicht.com/site/cmfciguey0me7vv19a6aj915n/dashboard', '_blank')">üåê APRI BAUSICHT</div>
                <div id="btn-admin-panel" class="menu-card" style="display: none; border: 2px solid var(--securitas-red);" onclick="Admin.open()">‚öôÔ∏è PANNELLO ADMIN</div>
            </div>
            <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 40px;">LOGOUT</button>
        </div>

        <div id="mod-accessi" class="module">
            <h2>GESTIONE ACCESSI E BADGE</h2>
            <button class="btn btn-danger" onclick="Router.go('mod-flow-badge')">‚ö†Ô∏è BADGE SMARRITO / DIMENTICATO</button>
            <button class="btn btn-outline" onclick="Accessi.showOFT()">üè¢ AZIENDA GESTITA DA OFT (Nijaz)</button>
            <button class="btn btn-outline" onclick="Accessi.showFFS()">üè¢ AZIENDA GESTITA DA FFS (La Morgia)</button>
            <hr>
            <button class="btn btn-secondary" onclick="Router.go('mod-menu')">TORNA AL MENU</button>
        </div>

        <div id="mod-flow-badge" class="module">
            <h3>PROCESSO GESTIONE BADGE</h3>
            
            <div class="flow-box">
                <b>FASE 1: VERIFICA</b><br>
                Cercare il nominativo su <b>Bausicht</b>. Se non esiste, deve registrarsi.
            </div>
            <div class="flow-box">
                <b>FASE 2: AZIONE SU BAUSICHT</b><br>
                - Se <b>SMARRITO</b>: Cliccare sul profilo -> Blocca Badge (Stato diventa Rosso).<br>
                - Se <b>DIMENTICATO</b>: Lasciare stato attivo ma procedere al ritiro garanzia.
            </div>
            <div class="flow-box">
                <b>FASE 3: RITIRO DOCUMENTO</b><br>
                Ritirare un documento d'identit√† originale o chiavi del veicolo personale. Custodire in cassaforte/ufficio.
            </div>
            <div class="flow-box">
                <b>FASE 4: BADGE PROVVISORIO</b><br>
                Consegnare il Badge Visitatore numerato. Registrare il numero consegnato.
            </div>
            <div class="flow-box">
                <b>FASE 5: RICONSEGNA</b><br>
                Al termine del turno: restituire il documento <u>SOLO</u> dopo aver ricevuto indietro il badge provvisorio.
            </div>
            <button class="btn btn-primary" onclick="Router.go('mod-accessi')">PROCEDURA COMPLETATA</button>
        </div>

        <div id="mod-checklist-menu" class="module">
            <h2>SELEZIONA TURNO</h2>
            <button class="btn btn-primary" onclick="Checklist.render('T1')">TURNO T1 (06:00 - 15:00)</button>
            <button class="btn btn-primary" onclick="Checklist.render('T2')">TURNO T2 (14:45 - 22:00)</button>
            <button class="btn btn-primary" onclick="Checklist.render('T3')">TURNO T3 (08:00 - 15:30)</button>
            <button class="btn btn-secondary" onclick="Router.go('mod-menu')">INDIETRO</button>
        </div>

        <div id="mod-checklist-view" class="module">
            <h2 id="check-title" style="text-align: center;"></h2>
            <div id="check-content"></div>
            <button class="btn btn-secondary" onclick="Router.go('mod-checklist-menu')" style="margin-top: 20px;">INDIETRO</button>
        </div>

    </div>

    <script>
        // --- 1. MODULO CORE (ROUTING E DATABASE) ---
        const App = {
            dbKey: 'nsif_v5_db',
            init: function() {
                if(!localStorage.getItem(this.dbKey)) {
                    const master = { email: "marco.lamorgia@securitas.ch", pass: "1234NSIF", role: "superadmin" };
                    localStorage.setItem(this.dbKey, JSON.stringify([master]));
                }
                this.updateClock();
            },
            updateClock: function() {
                const now = new Date();
                const opt = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                document.getElementById('display-date').innerText = now.toLocaleDateString('it-IT', opt).toUpperCase();
                setTimeout(() => this.updateClock(), 1000);
            }
        };

        const Router = {
            go: function(id) {
                document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo(0,0);
            }
        };

        // --- 2. MODULO AUTH & ADMIN ---
        const Auth = {
            currentUser: null,
            login: function() {
                const e = document.getElementById('login-email').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                const users = JSON.parse(localStorage.getItem(App.dbKey));
                const found = users.find(u => u.email === e && u.pass === p);
                
                if(found) {
                    this.currentUser = found;
                    if(found.role === 'admin' || found.role === 'superadmin') {
                        document.getElementById('btn-admin-panel').style.display = 'block';
                    }
                    Router.go('mod-menu');
                } else { alert("Credenziali errate."); }
            }
        };

        const Admin = {
            open: function() { this.renderTable(); Router.go('mod-admin'); },
            saveUser: function() {
                const email = document.getElementById('adm-email').value;
                const pass = document.getElementById('adm-pass').value;
                const role = document.getElementById('adm-role').value;
                let users = JSON.parse(localStorage.getItem(App.dbKey));
                
                const idx = users.findIndex(u => u.email === email);
                if(idx > -1) {
                    if(pass !== "") users[idx].pass = pass;
                    users[idx].role = role;
                } else {
                    users.push({email, pass, role});
                }
                localStorage.setItem(App.dbKey, JSON.stringify(users));
                this.renderTable();
                alert("Utente aggiornato.");
            },
            renderTable: function() {
                const users = JSON.parse(localStorage.getItem(App.dbKey));
                document.getElementById('user-list').innerHTML = users.map((u, i) => `
                    <tr>
                        <td>${u.email}</td>
                        <td>${u.role}</td>
                        <td>${u.role !== 'superadmin' ? `<button class="btn-danger" style="padding:5px" onclick="Admin.delete(${i})">Elimina</button>` : 'System'}</td>
                    </tr>
                `).join('');
            },
            delete: function(i) {
                let users = JSON.parse(localStorage.getItem(App.dbKey));
                users.splice(i, 1);
                localStorage.setItem(App.dbKey, JSON.stringify(users));
                this.renderTable();
            }
        };

        // --- 3. MODULO ACCESSI ---
        const Accessi = {
            showOFT: function() { alert("FLUSSO OFT:\n1. Riferimento: Nijaz\n2. Verificare autorizzazione\n3. Compilare modulo accompagnamento"); },
            showFFS: function() { alert("FLUSSO FFS:\n1. Riferimento: Marco La Morgia\n2. Verificare Bausicht\n3. Controllo DPI"); }
        };

        // --- 4. MODULO CHECKLIST ---
        const Checklist = {
            data: {
                T1: { "Inizio": ["Apertura Campo Base (6988)", "Ufficio Coordinamento (1907)", "Attivazione Telefono (6681)", "Radio Canale 15", "Apertura CAST07"], "Fine": ["Pulizia ufficio", "Passaggio consegna CAST09"] },
                T2: { "Inizio": ["Apertura CAST09 (6988)", "Ufficio CAST09 (1907)", "Verifica barriere", "Carica monopattino"], "Fine": ["Pulizia superfici", "Straccio terra (22:00)"] },
                T3: { "Inizio": ["Ritiro telefono CAST07", "Giro cantiere monopattino", "Verifica moduli"], "Fine": ["Riconsegna telefono CAST07"] }
            },
            render: function(turno) {
                const cont = document.getElementById('check-content');
                document.getElementById('check-title').innerText = "TURNO " + turno;
                cont.innerHTML = "";
                for(let sec in this.data[turno]) {
                    cont.innerHTML += `<div style="background:#003366; color:white; padding:10px; font-weight:bold; margin-top:15px;">${sec}</div>`;
                    this.data[turno][sec].forEach(task => {
                        cont.innerHTML += `<div class="check-row"><input type="checkbox" onchange="this.nextElementSibling.nextElementSibling.innerText=this.checked?new Date().toLocaleTimeString():''"> <label>${task}</label> <span class="timestamp"></span></div>`;
                    });
                }
                Router.go('mod-checklist-view');
            }
        };
    </script>
</body>
</html>
