<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSIF CASTIONE - GESTIONALE V 1.19.0</title>
    <style>
        :root { --blue: #003366; --red: #e30613; --bg: #f0f2f5; --white: #ffffff; --grey: #666; --warn: #ffcc00; --orange: #ff5722; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        .header { text-align: center; padding: 30px 20px; background: var(--white); border-bottom: 6px solid var(--red); }
        .logo-main { width: 95%; max-width: 1000px; height: auto; }
        .version-label { color: var(--blue); font-weight: 800; font-size: 1.8rem; text-transform: uppercase; margin-top:10px; }

        .nav-bar { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; padding: 15px; background: #e9ecef; position: sticky; top:0; z-index: 999; }
        .nav-btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; background: var(--white); color: var(--blue); border: 1px solid var(--blue); }
        .nav-btn:hover { background: var(--blue); color: var(--white); }
        .nav-btn.active { background: var(--red); color: var(--white); border-color: var(--red); }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; display: none; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 25px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: var(--white); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--blue); color: var(--white); text-transform: uppercase; font-size: 0.85rem; }

        /* Stili per Pulsanti Rapidi Targhe */
        .recenti-container { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
        .btn-targa { background: #e3f2fd; border: 1px solid #2196f3; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .btn-targa:hover { background: #bbdefb; }
        .btn-targa span.remove-targa { color: var(--red); font-weight: bold; padding: 0 5px; cursor: pointer; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center; flex-direction:column; color:white; }
        .modal-content { background:var(--white); color:#333; padding:30px; border-radius:12px; text-align:center; max-width:500px; width:90%; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; }
        .badge-user { background: #4caf50; }
        .badge-superuser { background: #2196f3; }
        .badge-admin { background: #f44336; }
        
        /* Widget Meteo e Orologi */
        .widgets { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .clock-card { background: var(--blue); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .clock-time { font-size: 1.5rem; font-weight: bold; display: block; }
    </style>
</head>
<body>

    <div id="login_screen" style="display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--blue);">
        <div class="card" style="width: 400px; text-align: center;">
            <img src="https://www.securitas.ch/fileadmin/templates/images/logo.svg" style="width: 200px; margin-bottom: 20px;">
            <h2>NSIF CASTIONE</h2>
            <input type="email" id="log_u" placeholder="Email">
            <input type="password" id="log_p" placeholder="Password">
            <button class="nav-btn" onclick="login()" style="width: 100%; margin-top: 15px; background: var(--red); color: white; border: none;">ACCEDI</button>
        </div>
    </div>

    <div id="main_app" style="display: none;">
        <div class="header">
            <img src="https://www.securitas.ch/fileadmin/templates/images/logo.svg" class="logo-main">
            <div class="version-label">NSIF CASTIONE - GESTIONALE WEB</div>
            <div id="user_info" style="margin-top: 10px; font-weight: bold; color: var(--blue);"></div>
        </div>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="showTab('home', this)">üè† HOME</button>
            <button class="nav-btn" onclick="showTab('fornitori', this)">üöõ FORNITORI</button>
            <button class="nav-btn" onclick="showTab('workflow', this)">üîÑ WORKFLOW</button>
            <button class="nav-btn" onclick="showTab('giornale', this)">üìì GIORNALE</button>
            <button class="nav-btn" onclick="showTab('checklist', this)">‚úÖ CHECKLIST</button>
            <button class="nav-btn" onclick="showTab('documenti', this)">üìÇ DOCUMENTI</button>
            <button class="nav-btn" id="btn_admin" onclick="showTab('admin', this)" style="display: none;">‚öôÔ∏è ADMIN</button>
            <button class="nav-btn" onclick="logout()" style="border-color: var(--red); color: var(--red);">ESCI</button>
        </div>

        <div id="home" class="container" style="display: block;">
            <div class="widgets">
                <div class="clock-card"><span>LONDRA</span><span class="clock-time" id="clock_lon">--:--</span></div>
                <div class="clock-card"><span>CASTIONE</span><span class="clock-time" id="clock_local">--:--</span></div>
                <div class="clock-card"><span>NEW YORK</span><span class="clock-time" id="clock_ny">--:--</span></div>
                <div class="clock-card"><span>TOKYO</span><span class="clock-time" id="clock_tok">--:--</span></div>
            </div>
            <div id="meteo_widget" class="card" style="background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); color: white; text-align: center;">
                Caricamento meteo Castione...
            </div>
            <div id="home_links" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;"></div>
        </div>

        <div id="fornitori" class="container">
            <div class="card">
                <h3>Nuovo Ingresso Veicolo</h3>
                <div class="recenti-container" id="recenti_targhe"></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <input type="text" id="f_azienda" placeholder="Azienda">
                    <input type="text" id="f_autista" placeholder="Autista">
                    <input type="text" id="f_targa" placeholder="Targa">
                    <select id="f_varco_in"></select>
                    <input type="number" id="f_timeout" placeholder="Timeout (minuti)" value="60">
                </div>
                <div style="margin: 15px 0;">
                    <label><input type="checkbox" id="f_casco"> Casco Indossato</label>
                    <label style="margin-left: 20px;"><input type="checkbox" id="f_gilet"> Gilet Alta Visibilit√†</label>
                </div>
                <button class="nav-btn" onclick="addFornitore()" style="background: var(--blue); color: white; width: 100%;">REGISTRA ENTRATA</button>
            </div>

            <div class="card">
                <h3>Mezzi in Cantiere</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Azienda</th>
                                <th>Targa</th>
                                <th>Entrata</th>
                                <th>Varco IN</th>
                                <th>Varco OUT</th>
                                <th>DPI</th>
                                <th>Permanenza</th>
                                <th>Azione</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_fornitori"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Mezzi Frequenti (Admin)</h3>
                <div id="predefiniti_list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
        </div>

        <div id="admin" class="container">
            <div class="card" style="border-left: 10px solid var(--orange);">
                <h3>Configurazione Varchi</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <input type="text" id="adm_v_nome" placeholder="Nome Varco (es. Nord, Sud)">
                    <input type="text" id="adm_v_coords" placeholder="Coordinate (opzionale)">
                    <input type="text" id="adm_v_note" placeholder="Note">
                </div>
                <button class="nav-btn" onclick="addVarco()" style="background: var(--orange); color: white; width: 100%; margin-top: 10px;">AGGIUNGI VARCO</button>
                <table>
                    <thead><tr><th>Nome</th><th>Note</th><th>Elimina</th></tr></thead>
                    <tbody id="tbody_adm_varchi"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>Gestione Utenti</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <input type="text" id="adm_u_nome" placeholder="Nome">
                    <input type="text" id="adm_u_cognome" placeholder="Cognome">
                    <input type="email" id="adm_u_email" placeholder="Email">
                    <input type="password" id="adm_u_pass" placeholder="Password">
                    <select id="adm_u_livello">
                        <option value="user">User</option>
                        <option value="superuser">Superuser</option>
                        <option value="admin">Admin</option>
                    </select>
                    <input type="number" id="adm_u_durata" placeholder="Durata (giorni)" value="365">
                </div>
                <button class="nav-btn" onclick="addUser()" id="btn_save_user" style="width: 100%; margin-top: 10px;">SALVA UTENTE</button>
                <table style="margin-top: 20px;">
                    <thead><tr><th>Utente</th><th>Email</th><th>Livello</th><th>Stato</th><th>Azioni</th></tr></thead>
                    <tbody id="tbody_utenti"></tbody>
                </table>
            </div>
            
            <div id="admin_extra_sections"></div> 
        </div>

        <div id="workflow" class="container"> <div class="card"><h3>Motore Workflow</h3><div id="wf_area"></div></div> </div>
        <div id="giornale" class="container"> <div class="card"><h3>Diario di Bordo</h3><textarea id="g_testo" placeholder="Scrivi evento..."></textarea><button onclick="addGiornale()">Invia</button><table id="table_giornale"></table></div> </div>
        <div id="checklist" class="container"> <div id="checklist_area"></div> </div>
        <div id="documenti" class="container"> <div class="card"><h3>Archivio PDF</h3><div id="docs_area"></div></div> </div>
    </div>

    <div id="alert_modal" class="modal">
        <div class="modal-content">
            <h1 style="color: var(--red); font-size: 3rem;">‚ö†Ô∏è ALLARME!</h1>
            <div id="alert_msg" style="font-size: 1.5rem; margin: 20px 0;"></div>
            <button class="nav-btn" id="btn_tutto_ok" style="background: green; color: white; padding: 20px 40px; font-size: 1.2rem;">TUTTO OK - RESET TIMEOUT</button>
        </div>
    </div>

    <script>
        // --- LOGICA AUDIO ---
        const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        alarmSound.loop = true;

        // --- DATABASE E STATO ---
        let db = JSON.parse(localStorage.getItem('nsif_v19_db')) || {
            users: [{id: 1, n: "Marco", c: "La Morgia", e: "marco.lamorgia@securitas.ch", p: "1234", l: "admin", s: true, d: 365}],
            links: [{n: "GESTIONE ACCESSI", u: "#"}],
            checklist: {}, giornale: [], docs: [], fornitori: [], predefiniti: [],
            workflows: [],
            varchi: [{id: 1, nome: "Main Gate", coords: "", note: "Accesso principale"}],
            recenti: []
        };

        let currentUser = null;
        let editUserId = null;

        function save() {
            localStorage.setItem('nsif_v19_db', JSON.stringify(db));
        }

        // --- LOGIN ---
        function login() {
            const e = document.getElementById('log_u').value;
            const p = document.getElementById('log_p').value;
            const u = db.users.find(x => x.e === e && x.p === p && x.s);
            if(u) {
                currentUser = u;
                document.getElementById('login_screen').style.display = 'none';
                document.getElementById('main_app').style.display = 'block';
                document.getElementById('user_info').innerText = `Operatore: ${u.n} ${u.c} (${u.l.toUpperCase()})`;
                if(u.l === 'admin') document.getElementById('btn_admin').style.display = 'block';
                localStorage.setItem('nsif_last_user', e);
                initApp();
            } else { alert("Accesso negato."); }
        }

        function logout() { location.reload(); }

        // --- NAVIGAZIONE ---
        function showTab(tabId, btn) {
            document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            if(btn) btn.classList.add('active');
            if(tabId === 'fornitori') renderFornitori();
            if(tabId === 'admin') renderAdminAll();
            if(tabId === 'home') renderHome();
        }

        // --- GESTIONE VARCHI (ADMIN) ---
        function addVarco() {
            const n = document.getElementById('adm_v_nome').value;
            const c = document.getElementById('adm_v_coords').value;
            const nt = document.getElementById('adm_v_note').value;
            if(!n) return alert("Inserire nome varco");
            db.varchi.push({ id: Date.now(), nome: n, coords: c, note: nt });
            save();
            renderAdminAll();
            document.getElementById('adm_v_nome').value = '';
        }

        function delVarco(id) {
            db.varchi = db.varchi.filter(v => v.id !== id);
            save();
            renderAdminAll();
        }

        // --- GESTIONE FORNITORI ---
        function addFornitore() {
            const az = document.getElementById('f_azienda').value;
            const aut = document.getElementById('f_autista').value;
            const tar = document.getElementById('f_targa').value.toUpperCase();
            const vin = document.getElementById('f_varco_in').value;
            const tout = parseInt(document.getElementById('f_timeout').value);

            if(!az || !tar || !vin) return alert("Compila Azienda, Targa e Varco");

            const nuovo = {
                id: Date.now(),
                azienda: az, autista: aut, targa: tar,
                varco_entrata: vin,
                varco_uscita: "",
                entrata: new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}),
                entrata_ts: Date.now(),
                uscita: "",
                casco: document.getElementById('f_casco').checked,
                gilet: document.getElementById('f_gilet').checked,
                timeout_min: tout,
                alert_scattato: false
            };

            db.fornitori.unshift(nuovo);

            // Aggiungi a targhe recenti se non esiste
            if(!db.recenti.find(r => r.targa === tar) && !db.predefiniti.find(p => p.targa === tar)) {
                db.recenti.push({azienda: az, autista: aut, targa: tar, casco: nuovo.casco, gilet: nuovo.gilet});
            }

            save();
            renderFornitori();
            // Reset campi
            ['f_azienda', 'f_autista', 'f_targa'].forEach(i => document.getElementById(i).value = "");
        }

        function renderFornitori() {
            // Render Select Varchi
            let vOptions = db.varchi.map(v => `<option value="${v.nome}">${v.nome}</option>`).join('');
            document.getElementById('f_varco_in').innerHTML = vOptions;

            // Render Pulsanti Rapidi
            let hRec = db.recenti.map(r => `
                <div class="btn-targa" onclick="recallTarga('${r.azienda}','${r.autista}','${r.targa}',${r.casco},${r.gilet})">
                    ${r.targa} <span class="remove-targa" onclick="event.stopPropagation(); delRecente('${r.targa}')">√ó</span>
                </div>
            `).join('');
            document.getElementById('recenti_targhe').innerHTML = hRec;

            // Render Predefiniti
            let hPre = db.predefiniti.map(p => `
                <button class="nav-btn" onclick="recallTarga('${p.azienda}','','${p.targa}',false,false)">${p.azienda} (${p.targa})</button>
            `).join('');
            document.getElementById('predefiniti_list').innerHTML = hPre;

            // Render Tabella
            let h = "";
            db.fornitori.forEach(f => {
                const rowStyle = (!f.uscita) ? "" : "background: #f9f9f9; color: #999;";
                h += `<tr style="${rowStyle}">
                    <td>${f.azienda}</td>
                    <td><b>${f.targa}</b></td>
                    <td>${f.entrata}</td>
                    <td>${f.varco_entrata}</td>
                    <td>${f.varco_uscita || "-"}</td>
                    <td>${f.casco ? '‚õëÔ∏è' : ''} ${f.gilet ? 'ü¶∫' : ''}</td>
                    <td>${calcPermanenza(f)}</td>
                    <td>
                        ${!f.uscita ? `<button onclick="registraUscita(${f.id})" style="background:var(--red); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">USCITA</button>` : 'COMPLETATO'}
                    </td>
                </tr>`;
            });
            document.getElementById('tbody_fornitori').innerHTML = h;
        }

        function recallTarga(az, aut, tar, c, g) {
            document.getElementById('f_azienda').value = az;
            document.getElementById('f_autista').value = aut;
            document.getElementById('f_targa').value = tar;
            document.getElementById('f_casco').checked = c;
            document.getElementById('f_gilet').checked = g;
        }

        function delRecente(targa) {
            db.recenti = db.recenti.filter(r => r.targa !== targa);
            save();
            renderFornitori();
        }

        function registraUscita(id) {
            const f = db.fornitori.find(x => x.id === id);
            if(f) {
                let vOut = prompt(`Conferma varco di USCITA per ${f.targa}:`, f.varco_entrata);
                if(vOut !== null) {
                    f.uscita = new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
                    f.varco_uscita = vOut;
                    save();
                    renderFornitori();
                }
            }
        }

        function calcPermanenza(f) {
            if(f.uscita) return "Terminata";
            let min = Math.floor((Date.now() - f.entrata_ts)/60000);
            return min + " min";
        }

        // --- ALLARMI ---
        function checkTimeouts() {
            const now = Date.now();
            db.fornitori.forEach(f => {
                if(!f.uscita && !f.alert_scattato) {
                    let trascorso = (now - f.entrata_ts) / 60000;
                    if(trascorso > f.timeout_min) {
                        f.alert_scattato = true;
                        triggerAlarm(f);
                    }
                }
            });
        }

        function triggerAlarm(f) {
            document.getElementById('alert_msg').innerHTML = `Il veicolo <b>${f.targa}</b> (${f.azienda}) √® in cantiere da oltre ${f.timeout_min} minuti!`;
            document.getElementById('alert_modal').style.display = 'flex';
            alarmSound.play().catch(e => console.log("Interazione utente necessaria per audio"));
            
            document.getElementById('btn_tutto_ok').onclick = function() {
                f.entrata_ts = Date.now(); // Reset timer
                f.alert_scattato = false;
                document.getElementById('alert_modal').style.display = 'none';
                alarmSound.pause();
                alarmSound.currentTime = 0;
                save();
            };
        }

        // --- ADMIN RENDER ---
        function renderAdminAll() {
            // Varchi
            let hv = "";
            db.varchi.forEach(v => {
                hv += `<tr><td>${v.nome}</td><td>${v.note}</td><td><button onclick="delVarco(${v.id})">‚ùå</button></td></tr>`;
            });
            document.getElementById('tbody_adm_varchi').innerHTML = hv;

            // Utenti
            let hu = "";
            db.users.forEach(u => {
                hu += `<tr>
                    <td>${u.n} ${u.c}</td>
                    <td>${u.e}</td>
                    <td><span class="badge badge-${u.l}">${u.l}</span></td>
                    <td>${u.s ? '‚úÖ ON' : 'üö´ OFF'}</td>
                    <td><button onclick="toggleUser(${u.id})">Switch</button></td>
                </tr>`;
            });
            document.getElementById('tbody_utenti').innerHTML = hu;
        }

        function toggleUser(id) {
            const u = db.users.find(x => x.id === id);
            if(u.e === currentUser.e) return alert("Non puoi disattivarti");
            u.s = !u.s; save(); renderAdminAll();
        }

        // --- UTILS ---
        function updateClocks() {
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('clock_local').innerText = new Date().toLocaleTimeString('it-IT', options);
            document.getElementById('clock_lon').innerText = new Date(new Date().getTime() - 3600000).toLocaleTimeString('it-IT', options);
            document.getElementById('clock_ny').innerText = new Date(new Date().getTime() - 21600000).toLocaleTimeString('it-IT', options);
            document.getElementById('clock_tok').innerText = new Date(new Date().getTime() + 28800000).toLocaleTimeString('it-IT', options);
        }

        function initApp() {
            setInterval(updateClocks, 1000);
            setInterval(checkTimeouts, 10000);
            renderHome();
        }

        function renderHome() {
            let h = "";
            db.links.forEach(l => {
                h += `<div class="card" style="cursor:pointer; text-align:center; border-top: 5px solid var(--blue);" onclick="window.open('${l.u}')">
                    <h3>${l.n}</h3>
                    <p>Accedi al portale esterno</p>
                </div>`;
            });
            document.getElementById('home_links').innerHTML = h;
        }

        window.onload = () => {
            const last = localStorage.getItem('nsif_last_user');
            if(last) document.getElementById('log_u').value = last;
        };
    </script>
</body>
</html>
