<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSIF CASTIONE - GESTIONALE V 1.20</title>
    <style>
        :root { --blue: #003366; --red: #e30613; --bg: #f4f7f6; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* LOGIN PAGE */
        #page_login { position: fixed; top:0; left:0; width: 100%; height: 100%; background: var(--blue); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* HEADER & NAV */
        header { background: var(--white); padding: 20px; text-align: center; border-bottom: 5px solid var(--red); }
        nav { background: #eee; padding: 10px; display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 999; flex-wrap: wrap; }
        .nav-btn { padding: 10px 20px; border: none; background: var(--blue); color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .nav-btn:hover { background: var(--red); }

        .container { display: none; padding: 30px; max-width: 1200px; margin: auto; }
        .active { display: block; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }

        /* DRAG & DROP */
        .drop-zone { border: 3px dashed #ccc; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 10px; background: #fafafa; }
        .drop-zone.hover { border-color: var(--blue); background: #eef; }

        /* FLOW EDITOR */
        #canvas_container { position: relative; width: 100%; height: 500px; background: #f0f0f0; border: 1px solid #ccc; overflow: hidden; border-radius: 8px; }
        .flow-node { 
            position: absolute; width: 150px; padding: 10px; background: white; 
            border: 2px solid var(--blue); border-radius: 5px; cursor: move; font-size: 12px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2); z-index: 10;
        }
        .node-start { border-color: green; background: #e8f5e9; }
        .node-end { border-color: red; background: #ffebee; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f8f8; }
    </style>
</head>
<body>

    <div id="page_login">
        <div class="login-card">
            <img src="https://www.securitas.ch/_assets/1f4f58cb8ec7ef7ef807190874a5a8cd/img/logos/securitas.svg" width="150">
            <input type="text" id="log_u" placeholder="User">
            <input type="password" id="log_p" placeholder="Password">
            <button class="nav-btn" style="width:100%; margin-top:10px" onclick="checkLogin()">ACCEDI</button>
        </div>
    </div>

    <div id="main_ui" style="display:none;">
        <header>
            <img src="logo_Consorzio.jpg" style="max-width:300px">
            <h2 id="main_clock">00:00:00</h2>
        </header>

        <nav>
            <button class="nav-btn" onclick="openPage('home')">HOME</button>
            <button class="nav-btn" onclick="openPage('badge')">BADGE</button>
            <button class="nav-btn" onclick="openPage('giornale')">GIORNALE</button>
            <button class="nav-btn" onclick="openPage('docs')">DOCUMENTI</button>
            <button id="admin_tab" class="nav-btn" style="background:#333; display:none;" onclick="openPage('admin')">ADMIN</button>
            <button class="nav-btn" style="background:var(--red)" onclick="location.reload()">LOGOUT</button>
        </nav>

        <div id="home" class="container active">
            <div class="card" style="text-align:center">
                <h1 id="date_display"></h1>
                <div id="link_container"></div>
            </div>
        </div>

        <div id="badge" class="container">
            <div class="card">
                <h3>Processi Badge Guidati</h3>
                <div id="badge_selector"></div>
                <hr>
                <div id="badge_run_area" style="text-align:center; min-height: 200px;"></div>
            </div>
        </div>

        <div id="docs" class="container">
            <div class="card">
                <h3>Documenti e Circolari</h3>
                <div id="docs_grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;"></div>
            </div>
        </div>

        <div id="admin" class="container">
            <div class="card">
                <h3>Visual Flow Editor (Badge)</h3>
                <div style="margin-bottom:10px;">
                    <input type="text" id="new_flow_name" placeholder="Nome Categoria (es: OFT)">
                    <button onclick="createFlow()">Crea Flusso</button>
                    <select id="edit_flow_select" onchange="loadFlowToCanvas(this.value)"></select>
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="width:250px; background:#eee; padding:10px; border-radius:5px;">
                        <input type="text" id="n_id" placeholder="ID (es: inizio)" style="width:100%"><br>
                        <textarea id="n_txt" placeholder="Testo domanda" style="width:100%"></textarea>
                        <div id="opt_list">
                            <div style="display:flex; gap:2px"><input type="text" class="o-v" placeholder="SÃ¬"><input type="text" class="o-t" placeholder="ID target"></div>
                        </div>
                        <button onclick="addOptRow()">+ Opzione</button>
                        <button onclick="saveNode()" style="width:100%; background:green; color:white; margin-top:10px;">SALVA NODO</button>
                    </div>
                    <div id="canvas_container"></div>
                </div>
            </div>

            <div class="card">
                <h3>Caricamento Documenti PDF</h3>
                <div id="drop_zone" class="drop-zone">Trascina il PDF qui o clicca per caricare</div>
                <input type="file" id="file_input" style="display:none" accept="application/pdf">
                <input type="text" id="doc_title" placeholder="Titolo">
                <button onclick="saveDoc()">PUBBLICA DOCUMENTO</button>
            </div>
        </div>
    </div>

    <script>
        // DATI DA index_attuale.txt + Estensioni
        const MASTER_ADMIN = "admin";
        let accounts = JSON.parse(localStorage.getItem('nsif_db_v18')) || [
            {e: "admin", p: "1234", l: "admin", s: "ATTIVO"}
        ];
        let badgeFlows = JSON.parse(localStorage.getItem('nsif_flows')) || {};
        let documents = JSON.parse(localStorage.getItem('nsif_docs')) || [];
        
        let currentUser = null;
        let tempPDF = null;
        let currentEditingFlow = null;

        function checkLogin() {
            const u = document.getElementById('log_u').value;
            const p = document.getElementById('log_p').value;
            const user = accounts.find(a => a.e === u && a.p === p && a.s === "ATTIVO");
            if(user) {
                currentUser = user;
                document.getElementById('page_login').style.display = 'none';
                document.getElementById('main_ui').style.display = 'block';
                if(user.l === 'admin') document.getElementById('admin_tab').style.display = 'inline-block';
                initApp();
            } else alert("Accesso fallito o account bloccato");
        }

        function initApp() {
            setInterval(() => {
                document.getElementById('main_clock').innerText = new Date().toLocaleTimeString('it-IT');
            }, 1000);
            document.getElementById('date_display').innerText = new Date().toLocaleDateString('it-IT', {weekday:'long', day:'numeric', month:'long'});
            
            setupDragDrop();
            renderBadgeSelectors();
            updateFlowSelect();
        }

        function openPage(id) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'docs') renderDocs();
        }

        // --- GESTIONE BADGE ---
        function createFlow() {
            const n = document.getElementById('new_flow_name').value.toUpperCase();
            if(!n) return;
            badgeFlows[n] = {};
            localStorage.setItem('nsif_flows', JSON.stringify(badgeFlows));
            updateFlowSelect();
        }

        function updateFlowSelect() {
            const sel = document.getElementById('edit_flow_select');
            sel.innerHTML = '<option>Seleziona Flusso...</option>' + Object.keys(badgeFlows).map(k => `<option value="${k}">${k}</option>`).join('');
        }

        function addOptRow() {
            const d = document.createElement('div');
            d.style.display = "flex"; d.style.gap="2px";
            d.innerHTML = `<input type="text" class="o-v" placeholder="SÃ¬"><input type="text" class="o-t" placeholder="ID target">`;
            document.getElementById('opt_list').appendChild(d);
        }

        function saveNode() {
            if(!currentEditingFlow) return alert("Seleziona un flusso!");
            const id = document.getElementById('n_id').value.trim();
            const txt = document.getElementById('n_txt').value;
            const vs = document.querySelectorAll('.o-v');
            const ts = document.querySelectorAll('.o-t');
            let opts = [];
            vs.forEach((v, i) => { if(v.value) opts.push({v: v.value, t: ts[i].value}); });

            if(!badgeFlows[currentEditingFlow][id]) {
                badgeFlows[currentEditingFlow][id] = { txt, opts, x: 50, y: 50 };
            } else {
                badgeFlows[currentEditingFlow][id].txt = txt;
                badgeFlows[currentEditingFlow][id].opts = opts;
            }
            localStorage.setItem('nsif_flows', JSON.stringify(badgeFlows));
            loadFlowToCanvas(currentEditingFlow);
        }

        function loadFlowToCanvas(cat) {
            currentEditingFlow = cat;
            const container = document.getElementById('canvas_container');
            container.innerHTML = "";
            const nodes = badgeFlows[cat];
            Object.keys(nodes).forEach(id => {
                const node = nodes[id];
                const div = document.createElement('div');
                div.className = `flow-node ${id==='inizio'?'node-start':''} ${node.opts.some(o=>o.t==='fine')?'node-end':''}`;
                div.style.left = node.x + "px"; div.style.top = node.y + "px";
                div.innerHTML = `<strong>${id}</strong><br>${node.txt.substring(0,20)}...`;
                
                div.onmousedown = (e) => {
                    let sX = e.clientX - div.offsetLeft;
                    let sY = e.clientY - div.offsetTop;
                    document.onmousemove = (ev) => {
                        let nX = ev.clientX - sX; let nY = ev.clientY - sY;
                        div.style.left = nX + "px"; div.style.top = nY + "px";
                        node.x = nX; node.y = nY;
                    };
                    document.onmouseup = () => { document.onmousemove = null; localStorage.setItem('nsif_flows', JSON.stringify(badgeFlows)); };
                };
                container.appendChild(div);
            });
        }

        function renderBadgeSelectors() {
            document.getElementById('badge_selector').innerHTML = Object.keys(badgeFlows).map(k => `
                <button class="nav-btn" style="background:orange; margin:5px" onclick="runBadge('${k}', 'inizio')">${k}</button>
            `).join('');
        }

        function runBadge(cat, nodeID) {
            const area = document.getElementById('badge_run_area');
            if(nodeID === 'fine') {
                area.innerHTML = "<h2>PROCESSO COMPLETATO</h2><button class='nav-btn' onclick='location.reload()'>OK</button>";
                return;
            }
            const node = badgeFlows[cat][nodeID];
            if(!node) return alert("Errore nel flusso: nodo non trovato");

            area.innerHTML = `
                <div class="card" style="display:inline-block; width:100%; max-width:500px">
                    <p style="font-size:1.2rem">${node.txt}</p>
                    <div style="display:flex; justify-content:center; gap:10px">
                        ${node.opts.map(o => `<button class="nav-btn" onclick="runBadge('${cat}', '${o.t}')">${o.v}</button>`).join('')}
                    </div>
                </div>
            `;
        }

        // --- GESTIONE DOCUMENTI PDF ---
        function setupDragDrop() {
            const dz = document.getElementById('drop_zone');
            const fi = document.getElementById('file_input');
            dz.onclick = () => fi.click();
            dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('hover'); };
            dz.ondragleave = () => dz.classList.remove('hover');
            dz.ondrop = (e) => {
                e.preventDefault(); dz.classList.remove('hover');
                processFile(e.dataTransfer.files[0]);
            };
            fi.onchange = (e) => processFile(e.target.files[0]);
        }

        function processFile(file) {
            if(file && file.type === "application/pdf") {
                const reader = new FileReader();
                reader.onload = (e) => { tempPDF = e.target.result; document.getElementById('drop_zone').innerText = "PDF Caricato: " + file.name; };
                reader.readAsDataURL(file);
            }
        }

        function saveDoc() {
            const title = document.getElementById('doc_title').value;
            if(!title || !tempPDF) return alert("Manca Titolo o File!");
            documents.push({id: Date.now(), title, data: tempPDF});
            localStorage.setItem('nsif_docs', JSON.stringify(documents));
            alert("Documento Salvato");
            tempPDF = null; document.getElementById('drop_zone').innerText = "Trascina il PDF qui o clicca";
        }

        function renderDocs() {
            document.getElementById('docs_grid').innerHTML = documents.map(d => `
                <div class="card" style="text-align:center">
                    <div style="font-size:40px; color:red">ðŸ“„</div>
                    <strong>${d.title}</strong><br><br>
                    <button class="nav-btn" onclick="viewDoc('${d.id}')">APRI PDF</button>
                </div>
            `).join('');
        }

        function viewDoc(id) {
            const d = documents.find(x => x.id == id);
            const win = window.open();
            win.document.write(`<iframe src="${d.data}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        }
    </script>
</body>
</html>
