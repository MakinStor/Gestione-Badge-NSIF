<style>
    /* ... stili esistenti ... */
    .row-pendente { background-color: #fff9c4 !important; border-left: 5px solid #fbc02d; }
    .btn-admin-action { 
        padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; 
        font-weight: bold; margin: 0 2px; transition: 0.3s;
    }
    .btn-mod { background: #2196f3; color: white; }
    .btn-mod:hover { background: #1976d2; }
    .btn-status { background: #ff9800; color: white; }
    .btn-status:hover { background: #f57c00; }
    .filter-bar { 
        background: #f8f9fa; padding: 10px; border-radius: 8px; 
        margin-bottom: 15px; display: flex; gap: 10px; align-items: center; 
    }
</style>

<div id="section_giornale" class="container">
    <div class="card">
        <h3>Diario di Bordo</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px 150px; gap:10px; margin-bottom:15px;">
            <input type="text" id="gb_luogo" placeholder="Luogo">
            <input type="text" id="gb_desc" placeholder="Descrizione">
            <input type="text" id="gb_misure" placeholder="Misure">
            <select id="gb_risolto">
                <option value="NO">NO (Pendente)</option>
                <option value="SI">SI (Risolto)</option>
            </select>
            <button class="nav-btn" style="background:green;" onclick="addGiornale()">REGISTRA</button>
        </div>

        <div class="filter-bar">
            <span>Filtra per:</span>
            <button class="freq-btn" onclick="renderGiornale('oggi')">Oggi</button>
            <button class="freq-btn" onclick="renderGiornale('tutti')">Storico Completo</button>
            <input type="date" id="filter_gb_date" onchange="renderGiornale('data')">
            <button class="nav-btn" style="background:var(--red); margin-left:auto;" onclick="generatePDF('giornale')">ðŸ“„ EXPORT PDF GIORNALE</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Data Inserimento</th>
                    <th>Agente</th>
                    <th>Dettagli / Luogo</th>
                    <th>Stato / Chiusura</th>
                    <th>Azione</th>
                </tr>
            </thead>
            <tbody id="tbody_giornale"></tbody>
        </table>
    </div>
</div>

<script>
    /* 4. LOGICA AGGIORNATA PER IL DIARIO DI BORDO */
    
    function addGiornale() {
        const entry = {
            id: Date.now(),
            t: new Date().toLocaleString(), // Data inserimento
            ts_iso: new Date().toISOString().split('T')[0],
            a: currentUser.n + " " + currentUser.c,
            l: document.getElementById('gb_luogo').value,
            d: document.getElementById('gb_desc').value,
            m: document.getElementById('gb_misure').value,
            r: document.getElementById('gb_risolto').value,
            chiusura: document.getElementById('gb_risolto').value === 'SI' ? new Date().toLocaleString() : null
        };
        db.giornale.push(entry);
        save();
        renderGiornale();
        // Reset campi
        ['gb_luogo', 'gb_desc', 'gb_misure'].forEach(id => document.getElementById(id).value = "");
    }

    function renderGiornale(filter = 'oggi') {
        const tbody = document.getElementById('tbody_giornale');
        const oggi = new Date().toISOString().split('T')[0];
        const filtroData = document.getElementById('filter_gb_date').value;

        let items = db.giornale.filter(g => {
            const isPendente = (g.r === 'NO');
            const isOggi = (g.ts_iso === oggi);
            
            if (filter === 'oggi') return isOggi || isPendente;
            if (filter === 'data') return g.ts_iso === filtroData;
            return true; // tutti
        });

        tbody.innerHTML = items.map(g => `
            <tr class="${g.r === 'NO' ? 'row-pendente' : ''}">
                <td>${g.t}</td>
                <td>${g.a}</td>
                <td><b>${g.l}</b><br>${g.d}</td>
                <td>
                    ${g.r === 'SI' ? `<span style="color:green">Risolto il:<br>${g.chiusura}</span>` : '<span style="color:red">PENDENTE</span>'}
                </td>
                <td>
                    ${g.r === 'NO' ? `<button onclick="chiudiNota(${g.id})">CHIUDI ORA</button>` : 'âœ…'}
                </td>
            </tr>
        `).reverse().join('');
    }

    function chiudiNota(id) {
        const nota = db.giornale.find(x => x.id === id);
        if(nota) {
            nota.r = 'SI';
            nota.chiusura = new Date().toLocaleString();
            save();
            renderGiornale();
        }
    }

    /* 5. MODIFICA RENDER UTENTI ADMIN (Tasti piÃ¹ belli) */
    function renderAdminAll() {
        // ... (parti precedenti del renderAdminAll) ...
        document.getElementById('tbody_adm_users').innerHTML = db.users.map(u => `
            <tr class="${!u.s ? 'status-off' : ''}">
                <td>${u.n} ${u.c}<br><small>${u.e}</small></td>
                <td>${u.l.toUpperCase()}</td>
                <td>${u.d} gg</td>
                <td>${u.s ? '<b style="color:green">ATTIVO</b>' : '<b style="color:red">DISATTIVATO</b>'}</td>
                <td>
                    <button class="btn-admin-action btn-mod" onclick="editUser(${u.id})">âœŽ MODIFICA</button>
                    <button class="btn-admin-action btn-status" onclick="toggleUser(${u.id})">ðŸ”„ STATO</button>
                </td>
            </tr>`).join('');
            
        // Aggiorna anche il counter fornitori con tasto PDF
        renderFornitori();
    }

    function renderFornitori() {
        const oggi = new Date().toLocaleDateString('it-IT');
        const listaOggi = (db.fornitori || []).filter(f => f.data === oggi);
        const inC = listaOggi.filter(x => !x.uscita).length;
        
        // Render tabella... (mantenere codice originale)
        
        // Update Counter Box con tasto PDF
        document.getElementById('counter_box').innerHTML = `
            <span>TRANSITI: ${listaOggi.length}</span> 
            <span style="color:red">IN CANTIERE: ${inC}</span> 
            <button class="nav-btn" style="background:var(--blue); font-size:0.7rem;" onclick="generatePDF('fornitori')">ðŸ“„ PDF ATTIVITÃ€</button>
        `;
    }

    /* 6. MOTORE DI GENERAZIONE PDF (Simulazione stampa/report) */
    function generatePDF(tipo) {
        let content = "";
        const dataReport = new Date().toLocaleString();
        
        if(tipo === 'giornale') {
            content = `<h1>DIARIO DI BORDO - REPORT ${dataReport}</h1>`;
            content += "<table><tr><th>Data</th><th>Agente</th><th>Nota</th><th>Stato</th></tr>";
            db.giornale.forEach(g => {
                content += `<tr><td>${g.t}</td><td>${g.a}</td><td>${g.d}</td><td>${g.r} (${g.chiusura || '---'})</td></tr>`;
            });
            content += "</table>";
        } else {
            content = `<h1>LOG FORNITORI - REPORT ${dataReport}</h1>`;
            content += "<table><tr><th>Ditta</th><th>Targa</th><th>Entrata</th><th>Uscita</th></tr>";
            db.fornitori.filter(f => f.data === new Date().toLocaleDateString('it-IT')).forEach(f => {
                content += `<tr><td>${f.azienda}</td><td>${f.targa}</td><td>${f.entrata}</td><td>${f.uscita || 'In cantiere'}</td></tr>`;
            });
            content += "</table>";
        }

        const win = window.open('', '_blank');
        win.document.write(`<html><head><title>Export PDF</title><style>table{width:100%; border-collapse:collapse;} th,td{border:1px solid #000; padding:8px; text-align:left;}</style></head><body>${content}</body></html>`);
        win.document.close();
        win.print();
    }
</script>
