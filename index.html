<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSIF CASTIONE - GESTIONALE V 1.9 BETA</title>
    <style>
        :root {
            --securitas-red: #e30613;
            --securitas-blue: #003366;
            --light-bg: #f8f9fa;
            --dark-grey: #333;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--light-bg); margin: 0; color: var(--dark-grey); }
        
        /* LOGIN PAGE */
        #page_login { position: fixed; top:0; left:0; width: 100%; height: 100%; background: var(--securitas-blue); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .login-footer-btns { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 10px; }
        .login-footer-btns a { color: var(--securitas-blue); text-decoration: none; cursor: pointer; }

        /* HEADER & LOGOS */
        .header { background: var(--white); border-bottom: 4px solid var(--securitas-red); padding: 20px; text-align: center; }
        .logo-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .logo-consorzio { max-width: 400px; height: auto; }
        .logo-securitas { max-width: 150px; }
        .version-label { color: var(--securitas-blue); font-weight: bold; font-size: 1.2rem; margin-top: 10px; }

        /* NAVIGATION */
        .nav-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 15px; background: #eee; position: sticky; top: 0; z-index: 999; }
        .nav-btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background: var(--securitas-blue); color: white; font-weight: bold; transition: 0.3s; }
        .nav-btn:hover { background: var(--securitas-red); }
        .nav-admin { background: #333; }

        /* SECTIONS */
        .container { display: none; padding: 30px; max-width: 1200px; margin: auto; animation: fadeIn 0.5s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* HOME DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .clock-main { font-size: 4rem; font-weight: bold; color: var(--securitas-blue); }
        .world-clocks { display: flex; justify-content: space-around; margin-top: 20px; font-family: monospace; }

        /* TABLES & FORMS */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f2f2f2; }
        .unresolved { background-color: #fff9c4 !important; }
        
        /* EXTERNAL LINKS BUTTONS */
        .link-section { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 20px; padding: 20px; background: #f0f0f0; border-radius: 10px; }
        .ext-link-btn { padding: 15px 25px; background: white; border: 2px solid var(--securitas-blue); color: var(--securitas-blue); font-weight: bold; border-radius: 5px; cursor: pointer; text-decoration: none; }
        .ext-link-btn:hover { background: var(--securitas-blue); color: white; }

        /* BADGE FLOW */
        .flow-box { border: 2px solid #ddd; padding: 20px; border-radius: 10px; background: #fff; max-width: 600px; margin: auto; }
    </style>
</head>
<body>

    <div id="page_login">
        <div class="login-card">
            <img src="https://www.securitas.ch/_assets/1f4f58cb8ec7ef7ef807190874a5a8cd/img/logos/securitas.svg" style="width:180px; margin-bottom:20px;">
            <input type="text" id="log_u" placeholder="E-mail" onkeydown="handleLoginKey(event, 'log_p')">
            <input type="password" id="log_p" placeholder="Password" onkeydown="handleLoginKey(event, 'btn_login')">
            <button id="btn_login" class="nav-btn" style="width: 100%; background: var(--securitas-red);" onclick="login()">CONFERMA</button>
            <div class="login-footer-btns">
                <a onclick="alert('Contattare l\'amministratore Marco La Morgia')">Password dimenticata?</a>
            </div>
            <div style="margin-top:20px; font-size:0.7rem; color:#888;">VERSIONE 1.9 BETA</div>
        </div>
    </div>

    <div id="main_ui" style="display:none;">
        <div class="header">
            <div class="logo-container">
                <img src="logo_Consorzio.jpg" class="logo-consorzio" alt="LOGO CONSORZIO NSIF" onerror="this.src='https://via.placeholder.com/400x120?text=LOGO+CONSORZIO+NSIF'">
                <img src="https://www.securitas.ch/_assets/1f4f58cb8ec7ef7ef807190874a5a8cd/img/logos/securitas.svg" class="logo-securitas">
                <div class="version-label">NSFI CASTIONE – GESTIONALE V 1.9 BETA</div>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-btn" onclick="showSection('section_home')">HOME</button>
            <button class="nav-btn" onclick="showSection('section_checklist')">CHECKLIST TURNI</button>
            <button class="nav-btn" onclick="showSection('section_badge')">GESTIONE ACCESSI</button>
            <button class="nav-btn" onclick="showSection('section_giornale')">GIORNALE DI BORDO</button>
            <button class="nav-btn" onclick="showSection('section_docs')">DOCUMENTI</button>
            <button id="nav_admin" class="nav-btn nav-admin" style="display:none;" onclick="showSection('section_admin')">AMMINISTRATORE</button>
            <button class="nav-btn" style="background:#666;" onclick="logout()">LOGOUT</button>
        </div>

        <div id="section_home" class="container active-page">
            <div class="card">
                <div id="date_display" style="font-size: 1.5rem; margin-bottom: 10px;"></div>
                <div id="main_clock" class="clock-main">00:00:00</div>
                <div class="world-clocks">
                    <div>Londra: <span id="clock_lon"></span></div>
                    <div>New York: <span id="clock_ny"></span></div>
                    <div>Tokyo: <span id="clock_tok"></span></div>
                </div>
            </div>
            
            <h3 style="text-align:center; margin-top:30px;">COLLEGAMENTI RAPIDI</h3>
            <div id="external_links_container" class="link-section">
                </div>
        </div>

        <div id="section_checklist" class="container">
            <div style="text-align:center; margin-bottom:30px;">
                <button class="nav-btn" onclick="renderChecklist('T1')">TURNO T1</button>
                <button class="nav-btn" onclick="renderChecklist('T2')">TURNO T2</button>
                <button class="nav-btn" onclick="renderChecklist('T3')">TURNO T3</button>
            </div>
            <div id="checklist_display"></div>
        </div>

        <div id="section_badge" class="container">
            <h2 style="text-align:center;">Flusso Creazione Badge / Accessi</h2>
            <div class="flow-box" id="badge_flow_content">
                <p>Selezionare il tipo di personale:</p>
                <button class="nav-btn" style="width:100%; margin-bottom:10px;" onclick="startFlow('OFT')">Personale OFT</button>
                <button class="nav-btn" style="width:100%; margin-bottom:10px;" onclick="startFlow('FFS')">Personale FFS</button>
                <button class="nav-btn" style="width:100%; background:orange;" onclick="startFlow('SPECIAL')">Badge Speciali (Visitatori/Stampa/CPC)</button>
            </div>
            <div id="flow_history" style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px; display:none;">
                <h4>Riepilogo Operazioni:</h4>
                <ul id="history_list"></ul>
                <button class="nav-btn" style="background:green" onclick="window.print()">SCARICA PDF (STAMPA)</button>
            </div>
        </div>

        <div id="section_giornale" class="container">
            <div class="card" style="text-align:left;">
                <h3>Nuova Registrazione</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="gb_luogo" placeholder="Luogo">
                    <input type="text" id="gb_desc" placeholder="Descrizione Attività">
                    <input type="text" id="gb_misure" placeholder="Misure attuate">
                    <select id="gb_risolto">
                        <option value="SI">Problema Risolto: SI</option>
                        <option value="NO">Problema Risolto: NO</option>
                    </select>
                </div>
                <button class="nav-btn" style="margin-top:15px; background:green;" onclick="addGiornale()">INSERISCI</button>
            </div>
            <table id="table_giornale">
                <thead>
                    <tr>
                        <th>Data/Ora</th>
                        <th>Agente</th>
                        <th>Luogo</th>
                        <th>Descrizione</th>
                        <th>Misure</th>
                        <th>Risolto</th>
                    </tr>
                </thead>
                <tbody id="tbody_giornale"></tbody>
            </table>
        </div>

        <div id="section_docs" class="container">
            <h3>Documentazione Operativa</h3>
            <div id="docs_list" class="dashboard-grid"></div>
        </div>

        <div id="section_admin" class="container">
            <div class="card" style="text-align:left;">
                <h3>Gestione Account</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="adm_e" placeholder="Email">
                    <input type="text" id="adm_p" placeholder="Password">
                    <select id="adm_l">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="superuser">Superuser</option>
                        <option value="guest">Guest</option>
                    </select>
                    <button class="nav-btn" style="background:green" onclick="addAccount()">AGGIUNGI</button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr><th>User</th><th>Pass</th><th>Livello</th><th>Durata (gg)</th><th>Stato</th><th>Azioni</th></tr>
                    </thead>
                    <tbody id="user_tbody"></tbody>
                </table>
            </div>

            <div class="card" style="text-align:left; margin-top:20px;">
                <h3>Gestione Link Esterni</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="link_n" placeholder="Nome Tasto">
                    <input type="text" id="link_u" placeholder="URL">
                    <button class="nav-btn" onclick="addLink()">AGGIUNGI LINK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DATA STORAGE INITIALIZATION
        let currentUser = null;
        const MASTER_ADMIN = "marco.lamorgia@securitas.ch";
        
        let db = JSON.parse(localStorage.getItem('nsif_v19_db')) || {
            accounts: [{e: MASTER_ADMIN, p: "1234", l: "admin", s: "ATTIVO", d: 999, n: "Marco", c: "La Morgia"}],
            links: [
                {n: "GESTIONE ACCESSI", u: "https://app.bausicht.com/site/cmfciguey0me7vv19a6aj915n/dashboard"},
                {n: "VTI External", u: "https://ssgwp.sharepoint.com/..."}
            ],
            giornale: [],
            docs: []
        };

        // LOGIN SYSTEM
        window.onload = () => {
            const lastUser = localStorage.getItem('last_user');
            if(lastUser) document.getElementById('log_u').value = lastUser;
        };

        function handleLoginKey(e, nextId) {
            if(e.key === "Enter") {
                e.preventDefault();
                const nextEl = document.getElementById(nextId);
                if(nextEl.tagName === "BUTTON") nextEl.click();
                else nextEl.focus();
            }
        }

        function login() {
            const u = document.getElementById('log_u').value;
            const p = document.getElementById('log_p').value;
            const user = db.accounts.find(a => a.e === u && a.p === p && a.s === "ATTIVO");

            if(user) {
                currentUser = user;
                localStorage.setItem('last_user', u);
                document.getElementById('page_login').style.display = 'none';
                document.getElementById('main_ui').style.display = 'block';
                if(user.l === 'admin') document.getElementById('nav_admin').style.display = 'block';
                initDashboard();
            } else {
                alert("Accesso negato. Dati errati o account bloccato.");
            }
        }

        function logout() { location.reload(); }

        // NAVIGATION
        function showSection(id) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            if(id === 'section_admin') renderAdmin();
            if(id === 'section_home') renderLinks();
            if(id === 'section_giornale') renderGiornale();
        }

        // DASHBOARD & CLOCKS
        function initDashboard() {
            updateTime();
            setInterval(updateTime, 1000);
            renderLinks();
        }

        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date_display').innerText = now.toLocaleDateString('it-IT', options).toUpperCase();
            document.getElementById('main_clock').innerText = now.toLocaleTimeString('it-IT');
            
            // World Clocks
            const timeOpts = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('clock_lon').innerText = new Date().toLocaleTimeString('it-IT', {...timeOpts, timeZone: 'Europe/London'});
            document.getElementById('clock_ny').innerText = new Date().toLocaleTimeString('it-IT', {...timeOpts, timeZone: 'America/New_York'});
            document.getElementById('clock_tok').innerText = new Date().toLocaleTimeString('it-IT', {...timeOpts, timeZone: 'Asia/Tokyo'});
        }

        // LINKS
        function renderLinks() {
            const container = document.getElementById('external_links_container');
            container.innerHTML = db.links.map(l => `
                <a href="${l.u}" target="_blank" class="ext-link-btn">${l.n}</a>
            `).join('');
        }

        function addLink() {
            const n = document.getElementById('link_n').value;
            const u = document.getElementById('link_u').value;
            if(n && u) {
                db.links.push({n, u});
                save();
                alert("Link aggiunto");
            }
        }

        // GIORNALE DI BORDO
        function addGiornale() {
            const entry = {
                ts: new Date().toLocaleString('it-IT'),
                agente: currentUser.n + " " + currentUser.c,
                luogo: document.getElementById('gb_luogo').value,
                desc: document.getElementById('gb_desc').value,
                misure: document.getElementById('gb_misure').value,
                risolto: document.getElementById('gb_risolto').value,
                id: Date.now()
            };
            db.giornale.push(entry);
            save();
            renderGiornale();
            // Reset form
            document.getElementById('gb_luogo').value = "";
            document.getElementById('gb_desc').value = "";
        }

        function renderGiornale() {
            const tbody = document.getElementById('tbody_giornale');
            const today = new Date().toLocaleDateString('it-IT');
            
            tbody.innerHTML = db.giornale
                .filter(entry => entry.ts.includes(today) || entry.risolto === "NO")
                .map(entry => `
                <tr class="${entry.risolto === 'NO' ? 'unresolved' : ''}">
                    <td>${entry.ts}</td>
                    <td>${entry.agente}</td>
                    <td>${entry.luogo}</td>
                    <td>${entry.desc}</td>
                    <td>${entry.misure}</td>
                    <td>
                        <select onchange="updateGbStatus(${entry.id}, this.value)">
                            <option value="SI" ${entry.risolto==='SI'?'selected':''}>SI</option>
                            <option value="NO" ${entry.risolto==='NO'?'selected':''}>NO</option>
                        </select>
                    </td>
                </tr>
            `).reverse().join('');
        }

        function updateGbStatus(id, val) {
            const idx = db.giornale.findIndex(e => e.id === id);
            db.giornale[idx].risolto = val;
            save();
            renderGiornale();
        }

        // BADGE FLOW (BASIC LOGIC)
        function startFlow(type) {
            const box = document.getElementById('badge_flow_content');
            const hist = document.getElementById('flow_history');
            const list = document.getElementById('history_list');
            hist.style.display = 'block';
            
            if(type === 'SPECIAL') {
                box.innerHTML = `
                    <h4>Badge Speciali</h4>
                    <button class="nav-btn" onclick="logFlow('Visitatori','Selezionato'); nextStep('annunciato')">Visitatori</button>
                    <button class="nav-btn" onclick="logFlow('Stampa','Selezionato'); alert('Controllare documenti, chiamare FFS')">Stampa/TV</button>
                `;
            }
        }

        function logFlow(step, action) {
            const list = document.getElementById('history_list');
            list.innerHTML += `<li>${new Date().toLocaleTimeString()} - ${step}: ${action} (Operatore: ${currentUser.n})</li>`;
        }

        // ADMIN RENDER
        function renderAdmin() {
            const tbody = document.getElementById('user_tbody');
            tbody.innerHTML = db.accounts.map((a, i) => `
                <tr>
                    <td>${a.e}</td>
                    <td><input type="text" value="${a.p}" onchange="updateAccount(${i}, 'p', this.value)"></td>
                    <td>
                        <select onchange="updateAccount(${i}, 'l', this.value)">
                            <option value="user" ${a.l=='user'?'selected':''}>User</option>
                            <option value="admin" ${a.l=='admin'?'selected':''}>Admin</option>
                            <option value="superuser" ${a.l=='superuser'?'selected':''}>Superuser</option>
                        </select>
                    </td>
                    <td><input type="number" style="width:50px" value="${a.d}" onchange="updateAccount(${i}, 'd', this.value)"></td>
                    <td style="color:${a.s==='ATTIVO'?'green':'red'}"><strong>${a.s}</strong></td>
                    <td>
                        <button onclick="toggleAcc(${i})">Sblocca/Blocca</button>
                        ${a.e !== MASTER_ADMIN ? `<button onclick="delAcc(${i})">Elimina</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function updateAccount(i, f, v) { db.accounts[i][f] = v; save(); }
        function toggleAcc(i) { db.accounts[i].s = db.accounts[i].s === "ATTIVO" ? "BLOCCATO" : "ATTIVO"; save(); renderAdmin(); }
        function delAcc(i) { if(confirm("Eliminare?")) { db.accounts.splice(i,1); save(); renderAdmin(); } }
        function addAccount() {
            const e = document.getElementById('adm_e').value;
            const p = document.getElementById('adm_p').value;
            const l = document.getElementById('adm_l').value;
            if(e && p) {
                db.accounts.push({e, p, l, s: "ATTIVO", d: 365, n: "Nuovo", c: "Utente"});
                save(); renderAdmin();
            }
        }

        function save() {
            localStorage.setItem('nsif_v19_db', JSON.stringify(db));
        }
    </script>
</body>
</html>
